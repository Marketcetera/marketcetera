<?xml version="1.0" encoding="UTF-8" ?>

<!--
  - Main server configuration.
  -
  - Author: tlerios@marketcetera.com
  - Since: 1.0.0
  - Version: $Id: server.xml 16725 2013-10-29 20:33:04Z colin $
  - $License$
  -->

<!--
  - See 'README.html' for detailed documentation.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:jpa="http://www.springframework.org/schema/data/jpa"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd
                           http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
                           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.2.xsd">
  <import resource="db.xml"/>
  <import resource="brokers/main.xml"/>
  <import resource="filters/main.xml"/>
  <import resource="messaging/main.xml"/>
  <!-- unique id generator -->
  <bean id="idFactory" class="org.marketcetera.ors.dao.DatabaseIDFactory" init-method="init"/>
  <!-- ORS object -->
  <bean id="ors" class="org.marketcetera.ors.OrderRoutingSystem">
    <property name="config" ref="orsConfig"/>
    <property name="jmsManager" ref="jmsManager"/>
    <property name="reportHistoryServices" ref="reportHistoryServices"/>
    <property name="replyPersister" ref="replyPersister"/>
    <property name="systemInfo" ref="systemInfo"/>
    <property name="brokers" ref="brokers"/>
    <property name="selector" ref="selector"/>
    <property name="userManager" ref="orsUserManager"/>
    <property name="clientSessionFactory" ref="clientSessionFactory"/>
    <property name="sessionManager" ref="orsSessionManager"/>
    <property name="server" ref="orsServer"/>
    <property name="service" ref="orsService"/>
    <property name="quickFixSender" ref="orsQuickFixSender"/>
    <property name="idFactory" ref="orsIdFactory"/>
    <property name="requestHandler" ref="orsRequestHandler"/>
  </bean>
  <!-- ORS Reply Persister -->
  <bean id="replyPersister" class="org.marketcetera.ors.ReplyPersister">
    <constructor-arg ref="reportHistoryServices"/>
    <constructor-arg ref="orderInfoCache"/>
  </bean>
  <!-- ORS Order Info Cache -->
  <bean id="orderInfoCache" class="org.marketcetera.ors.SimpleOrderInfoCache"/>
  <!-- ORS JMS manager -->
  <bean id="jmsManager" class="org.marketcetera.client.jms.JmsManager">
    <constructor-arg ref="metc_connection_factory_in"/>
    <constructor-arg ref="metc_connection_factory_out"/>
  </bean>
  <!-- ORS System Info -->
  <bean id="systemInfo" class="org.marketcetera.ors.info.SystemInfoImpl"/>
  <!-- ORS Report History Services -->
  <bean id="reportHistoryServices" class="org.marketcetera.ors.history.BasicReportHistoryServices"/>
  <!-- ORS Brokers -->
  <bean id="brokers" class="org.marketcetera.ors.brokers.Brokers">
    <constructor-arg ref="metc_brokers"/>
    <constructor-arg ref="reportHistoryServices"/>
  </bean>
  <!-- ORS Selector -->
  <bean id="selector" class="org.marketcetera.ors.brokers.Selector">
    <constructor-arg ref="brokers"/>
    <constructor-arg ref="metc_selector"/>
  </bean>
  <!-- ORS User Manager -->
  <bean id="orsUserManager" class="org.marketcetera.ors.UserManager"/>
  <!-- ORS Client Session Factory -->
  <bean id="clientSessionFactory" class="org.marketcetera.ors.ws.ClientSessionFactory">
    <constructor-arg ref="systemInfo"/>
    <constructor-arg ref="jmsManager"/>
    <constructor-arg ref="orsUserManager"/>
  </bean>
  <!-- ORS Session Manager -->
  <bean id="orsSessionManager" class="org.marketcetera.util.ws.stateful.SessionManager">
    <constructor-arg ref="clientSessionFactory"/>
    <constructor-arg value="-1"/> <!-- infinite session life, otherwise specify a ms value -->
  </bean>
  <!-- ORS Web Server -->
  <bean id="orsServer" class="org.marketcetera.util.ws.stateful.Server">
    <constructor-arg value="${metc.ws.host}"/> <!-- web-services hostname -->
    <constructor-arg value="${metc.ws.port}"/> <!-- web-services port -->
    <constructor-arg ref="dbAuthenticator"/>
    <constructor-arg ref="orsSessionManager"/>
  </bean>
  <!-- ORS Web Service -->
  <bean id="orsService" class="org.marketcetera.ors.ws.ServiceImpl">
    <constructor-arg ref="orsSessionManager"/>
    <constructor-arg ref="brokers"/>
    <constructor-arg ref="orsIdFactory"/>
    <constructor-arg ref="reportHistoryServices"/>
    <constructor-arg ref="symbolResolver"/>
    <constructor-arg ref="userService"/>
  </bean>
  <!-- ORS QuickFix Sender -->
  <bean id="orsQuickFixSender" class="org.marketcetera.quickfix.QuickFIXSenderImpl"/>
  <!-- ORS ID Factory -->
  <bean id="orsIdFactory" class="org.marketcetera.ors.LocalIDFactory" init-method="init">
    <constructor-arg ref="idFactory"/>
  </bean>
  <!-- ORS Request Handler -->
  <bean id="orsRequestHandler" class="org.marketcetera.ors.RequestHandler">
    <constructor-arg ref="brokers"/>
    <constructor-arg ref="selector"/>
    <constructor-arg><list/></constructor-arg> <!-- allowed orders filter -->
      <!-- 
        <list>
            <ref bean="metc_allowed_orders"/>
            <ref bean="metc_restricted_users"/>
        </list>
       -->
    <constructor-arg ref="replyPersister"/>
    <constructor-arg ref="orsQuickFixSender"/>
    <constructor-arg ref="orsUserManager"/>
    <constructor-arg ref="idFactory"/>
  </bean>
  <!-- ORS config object -->
  <bean id="orsConfig" class="org.marketcetera.ors.config.SpringConfig">
    <!-- The brokers. -->
    <property name="brokers" ref="metc_brokers"/>
    <!-- The broker selector. -->
    <property name="selector" ref="metc_selector"/>
    <!-- The WS hostname. -->
    <property name="serverHost" value="${metc.ws.host}"/>
    <!-- The WS port. -->
    <property name="serverPort" value="${metc.ws.port}"/>
    <!--
      - The length of a WS session, in seconds; -1 means sessions
      - never expire.
      -->
    <property name="serverSessionLife" value="${metc.ws.session.life}"/>
    <!-- The connection factory for incoming JMS connections. -->
    <property name="incomingConnectionFactory" ref="metc_connection_factory_in"/>
    <!-- The connection factory for outgoing JMS connections. -->
    <property name="outgoingConnectionFactory" ref="metc_connection_factory_out"/>
    <!-- The ID generation factory. -->
    <property name="IDFactory" ref="orsIdFactory"/>
    <!-- The report history services provider. -->
    <property name="reportHistoryServices" ref="reportHistoryServices"/>
    <!-- symbol resolver services -->
    <property name="symbolResolverServices" ref="symbolResolver"/>
    <!-- The order information cache. -->
    <property name="orderInfoCache" ref="orderInfoCache"/>
  </bean>
  <bean class="org.marketcetera.ors.OptionRootUnderlyingMap">
    <property name="filename" value="${metc.optionroot.map.file}"/>
    <property name="includeTypes" value="EU,EL"/>
  </bean>
  <!--  authenticator -->
  <bean id="dbAuthenticator" class="org.marketcetera.ors.ws.DBAuthenticator"/>
</beans>
